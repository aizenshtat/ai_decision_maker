<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Decision Maker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div id="app" class="container">
        <h1>AI Decision Maker</h1>
        <div v-if="!isLoggedIn">
            <p>Please <a href="/login">login</a> or <a href="/register">register</a> to use the AI Decision Maker.</p>
        </div>
        <div v-else>
            <div v-if="!decisionStarted">
                <h2>Start a New Decision</h2>
                <label for="decision-question">What decision do you need help with?</label>
                <textarea id="decision-question" v-model="decisionQuestion" required></textarea>
                
                <label for="decision-type">Type of Decision:</label>
                <select id="decision-type" v-model="decisionType" @change="updateFrameworkInfo">
                    <option v-for="(framework, key) in frameworks" :value="key">${framework.name}</option>
                </select>
                
                <div v-if="selectedFramework">
                    <h3>About this framework:</h3>
                    <p><strong>When to use:</strong> ${selectedFramework.explanation}</p>
                    <p><strong>Example:</strong> ${selectedFramework.example}</p>
                </div>
                
                <button @click="startDecision" :disabled="!decisionQuestion || isLoading">
                    ${isLoading ? 'Processing...' : 'Start Decision Process'}
                </button>
            </div>
    
            <div v-else-if="!decisionCompleted">
                <h2>${currentStep.title}</h2>
                <p>${currentStep.description}</p>
                <div v-if="aiSuggestion" class="ai-suggestion">
                    <h3>AI Suggestion:</h3>
                    <div v-html="formattedAiSuggestion"></div>
                </div>
                <div class="step-input" v-if="currentStep.title === 'Formulate the decision'">
                    <label for="refined-decision">Refined Decision:</label>
                    <textarea
                        id="refined-decision"
                        v-model="stepInputs.formulatedDecision"
                        rows="3"
                        class="form-control"
                    ></textarea>
                </div>
                <div class="step-input" v-else-if="currentStep.title === 'List options'">
                    <div v-for="(option, index) in stepInputs.options" :key="index" class="option-item">
                        <input v-model="option.name" :placeholder="'Option ' + (index + 1)">
                        <textarea v-model="option.description" placeholder="Description"></textarea>
                        <textarea v-model="option.pros" placeholder="Pros"></textarea>
                        <textarea v-model="option.cons" placeholder="Cons"></textarea>

                        <button @click="removeOption(index)" v-if="stepInputs.options.length > 1">Remove</button>
                    </div>
                    <button @click="addOption">Add Option</button>
                </div>
                <div class="step-input" v-else-if="currentStep.title === 'Define factors'">
                    <div v-for="(factor, index) in stepInputs.factors" :key="index">
                        <input v-model="factor.name" :placeholder="'Factor ' + (index + 1)">
                        <button @click="removeFactor(index)" v-if="stepInputs.factors.length > 1">Remove</button>
                    </div>
                    <button @click="addFactor">Add Factor</button>
                </div>
                <div class="step-input" v-else-if="currentStep.title === 'Weigh outcomes'">
                    <div v-for="(option, optionIndex) in stepInputs.options" :key="'option-' + optionIndex">
                        <h4>${option.name}</h4>
                        <div v-for="(factor, factorIndex) in stepInputs.factors" :key="'factor-' + factorIndex">
                            <label>${factor.name}</label>
                            <input type="range" v-model="stepInputs.weights[optionIndex][factorIndex]" min="1" max="10">
                            <span>${stepInputs.weights[optionIndex][factorIndex]}</span>
                        </div>
                    </div>
                </div>
                <div class="step-input" v-else-if="currentStep.title === 'Make a choice'">
                    <select v-model="stepInputs.finalChoice">
                        <option v-for="option in stepInputs.options" :value="option.name">${option.name}</option>
                    </select>
                    <textarea v-model="stepInputs.reasoning" placeholder="Reasoning for your choice"></textarea>
                </div>
                <div class="navigation-buttons">
                    <button @click="previousStep" v-if="currentStepIndex > 0">Previous Step</button>
                    <button @click="submitStep" :disabled="!isStepValid || isLoading">
                        ${isLoading ? 'Processing...' : 'Next Step'}
                    </button>
                    <button @click="startOver">Start Over</button>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" :style="{ width: progress + '%' }"></div>
                </div>
                <p class="progress-text">${Math.round(progress)}% Complete</p>
            </div>
    
            <div v-else>
                <h2>Decision Summary</h2>
                <div class="decision-summary">
                    <p>${decisionSummary}</p>
                </div>
                <button @click="saveDecision" :disabled="decisionSaved">
                    ${decisionSaved ? 'Decision Saved' : 'Save Decision'}
                </button>
            
                <div v-if="decisionSaved && !feedbackSubmitted" class="feedback-form">
                    <h3>Provide Feedback</h3>
                    <p>How helpful was this decision-making process?</p>
                    <div class="rating">
                        <span v-for="i in 5" :key="i" @click="rating = i" :class="{ 'selected': rating >= i }">☆</span>
                    </div>
                    <textarea v-model="feedbackComment" placeholder="Additional comments (optional)"></textarea>
                    <button @click="submitFeedback">Submit Feedback</button>
                </div>
            
                <div v-if="feedbackSubmitted" class="feedback-submitted">
                    <p>Thank you for your feedback!</p>
                </div>
            </div>
    
            <div v-if="error" class="error">
                ${error}
            </div>
    
            <div v-if="savedDecisions.length > 0" class="saved-decisions">
                <h2>Your Saved Decisions</h2>
                <ul>
                    <li v-for="decision in savedDecisions" :key="decision.id" class="decision-item">
                        <h3>${decision.question}</h3>
                        <p><strong>Framework:</strong> ${decision.framework}</p>
                        <p><strong>Created:</strong> ${new Date(decision.created_at).toLocaleString()}</p>
                        <div v-if="decision.feedback" class="decision-feedback">
                            <p><strong>Your Feedback:</strong> ${decision.feedback.rating}/5 stars</p>
                            <p v-if="decision.feedback.comment"><em>"${decision.feedback.comment}"</em></p>
                        </div>
                        <div v-else class="no-feedback">
                            <p>No feedback provided</p>
                        </div>
                        <button @click="showDecisionDetails(decision)">View Details</button>
                    </li>
                </ul>
            </div>
    
            <div v-if="savedDecisions.length > 1" class="decision-comparison">
                <h2>Compare Decisions</h2>
                <select v-model="selectedDecisions" multiple>
                    <option v-for="decision in savedDecisions" :value="decision.id">${decision.question}</option>
                </select>
                <button @click="compareDecisions" :disabled="selectedDecisions.length < 2">Compare Selected Decisions</button>
                <div v-if="comparisonResult">
                    <h3>Comparison Result:</h3>
                    <p>${comparisonResult}</p>
                </div>
            </div>

            <div v-if="selectedDecision" class="modal">
                <div class="modal-content">
                    <span class="close" @click="closeDecisionDetails">&times;</span>
                    <h2>Decision Details</h2>
                    <p><strong>Question:</strong> ${selectedDecision.question}</p>
                    <p><strong>Framework:</strong> ${selectedDecision.framework}</p>
                    <p><strong>Created:</strong> ${new Date(selectedDecision.created_at).toLocaleString()}</p>
                    <h3>Response:</h3>
                    <div v-if="selectedDecision.parsedResponse">
                        <div v-for="(step, index) in selectedDecision.parsedResponse.steps" :key="index">
                            <h4>Step ${index + 1}</h4>
                            <p>${step}</p>
                        </div>
                        <h4>Summary</h4>
                        <p>${selectedDecision.parsedResponse.summary}</p>
                    </div>
                    <div v-else>
                        <p>${selectedDecision.response}</p>
                    </div>
                    <div v-if="selectedDecision.feedback">
                        <h3>Your Feedback</h3>
                        <p><strong>Rating:</strong> ${selectedDecision.feedback.rating}/5 stars</p>
                        <p v-if="selectedDecision.feedback.comment"><strong>Comment:</strong> ${selectedDecision.feedback.comment}</p>
                    </div>
                    <div v-else>
                        <h3>Provide Feedback</h3>
                        <div class="feedback-form">
                            <p>How helpful was this decision-making process?</p>
                            <div class="rating">
                                <span v-for="i in 5" :key="i" @click="setRating(i)" :class="{ 'selected': rating >= i }">☆</span>
                            </div>
                            <textarea v-model="feedbackComment" placeholder="Additional comments (optional)"></textarea>
                            <button @click="submitFeedback(selectedDecision.id)">Submit Feedback</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    new Vue({
        el: '#app',
        delimiters: ['${', '}'],
        data: {
            isLoggedIn: false,
            decisionQuestion: '',
            decisionType: 'personal',
            frameworks: {},
            selectedFramework: null,
            decisionStarted: false,
            currentStep: {},
            currentStepInput: '',
            aiSuggestion: {
                content: {
                    refinedDecision: '',
                    alternatives: [],
                    considerations: ''
                }
            },
            progress: 0,
            decisionCompleted: false,
            decisionSummary: '',
            allStepInputs: [],
            error: '',
            savedDecisions: [],
            userFeedback: [],
            selectedDecisions: [],
            comparisonResult: null,
            decisionSaved: false,
            rating: 0,
            feedbackComment: '',
            feedbackSubmitted: false,
            savedDecisionId: null,
            isLoading: false,
            selectedDecision: null,
            stepInputs: {
                formulatedDecision: '',
                options: [],
                factors: [],
                weights: {},
                finalChoice: '',
                reasoning: ''
            },
            currentStepIndex: 0
        },
        computed: {
            formattedAiSuggestion() {
                if (!this.aiSuggestion) return '';
                let formatted = `<div class="preserve-newlines">${marked.parse(this.aiSuggestion.suggestion)}</div>`;
                
                switch (this.currentStep.title) {
                    case 'Formulate the decision':
                        formatted += `<h4>Refined Decision:</h4><div class="preserve-newlines">${this.aiSuggestion.content.refinedDecision}</div>`;
                        formatted += '<h4>Alternative Formulations:</h4><ul>';
                        this.aiSuggestion.content.alternatives.forEach(alt => {
                            formatted += `<li class="preserve-newlines">${alt}</li>`;
                        });
                        formatted += '</ul>';
                        formatted += `<h4>Explanation:</h4><div class="preserve-newlines">${this.aiSuggestion.content.explanation}</div>`;
                        break;
                    case 'List options':
                        formatted += '<h4>Suggested Options:</h4>';
                        this.aiSuggestion.content.options.forEach(option => {
                            formatted += `<p><strong>${option.name}:</strong> <span class="preserve-newlines">${option.description}</span></p>`;
                        });
                        break;
                    case 'Define factors':
                        formatted += '<h4>Suggested Factors:</h4>';
                        this.aiSuggestion.content.factors.forEach(factor => {
                            formatted += `<p><strong>${factor.name}:</strong> <span class="preserve-newlines">${factor.explanation}</span></p>`;
                        });
                        break;
                    case 'Weigh outcomes':
                        formatted += `<h4>How to Weigh Outcomes:</h4><div class="preserve-newlines">${this.aiSuggestion.content.explanation}</div>`;
                        break;
                    case 'Make a choice':
                        formatted += `<h4>Analysis:</h4><div class="preserve-newlines">${this.aiSuggestion.content.analysis}</div>`;
                        formatted += `<h4>Top Recommendation:</h4><div class="preserve-newlines">${this.aiSuggestion.content.topRecommendation}</div>`;
                        break;
                }
                
                return formatted;
            },
            isStepValid() {
                switch (this.currentStep.title) {
                    case 'Formulate the decision':
                        return this.stepInputs.formulatedDecision !== '';
                    case 'List options':
                        return this.stepInputs.options.length > 0 && this.stepInputs.options.every(option => option.name.trim() !== '');
                    case 'Define factors':
                        return this.stepInputs.factors.length > 0 && this.stepInputs.factors.every(factor => factor.name.trim() !== '');
                    case 'Weigh outcomes':
                        return Object.keys(this.stepInputs.weights).length === this.stepInputs.options.length;
                    case 'Make a choice':
                        return this.stepInputs.finalChoice !== '' && this.stepInputs.reasoning.trim() !== '';
                    default:
                        return true;
                }
            }
        },
        methods: {
            updateFrameworkInfo() {
                this.selectedFramework = this.frameworks[this.decisionType];
            },
            startDecision() {
                if (this.isLoading) return;
                this.isLoading = true;
                this.decisionStarted = true;
                this.getNextStep();
            },
            addOption() {
                this.stepInputs.options.push({ name: '', description: '', pros: '', cons: '' });
            },
            removeOption(index) {
                this.stepInputs.options.splice(index, 1);
            },
            addFactor() {
                this.stepInputs.factors.push({ name: '' });
            },
            removeFactor(index) {
                this.stepInputs.factors.splice(index, 1);
            },
            submitStep() {
                if (this.isLoading) return;
                this.isLoading = true;
                console.log('Submitting step:', this.currentStep.title);
                this.getNextStep();
            },
            getNextStep() {
                console.log('Getting next step...');
                axios.post('/get_next_step', {
                    decision_type: this.decisionType,
                    current_step: this.currentStepIndex,
                    decision_question: this.stepInputs.formulatedDecision || this.decisionQuestion,
                    user_inputs: this.stepInputs
                })
                .then(response => {
                    console.log('Received response:', response.data);
                    if (response.data.completed) {
                        this.decisionCompleted = true;
                        this.decisionSummary = response.data.summary;
                        this.progress = 100;
                    } else {
                        this.currentStep = response.data.step;
                        this.aiSuggestion = response.data.ai_suggestion;
                        this.progress = response.data.progress;
                        this.currentStepIndex++;
                        console.log('Initializing step inputs for:', this.currentStep.title);
                        this.initializeStepInputs();
                    }
                })
                .catch(error => {
                    console.error('Error getting next step:', error);
                    this.error = 'Error in decision process. Please try again.';
                })
                .finally(() => {
                    this.isLoading = false;
                    console.log('Step processing completed');
                });
            },
            initializeStepInputs() {
                console.log('Initializing step inputs:', this.currentStep.title);
                console.log('AI Suggestion:', this.aiSuggestion);
                switch (this.currentStep.title) {
                    case 'Formulate the decision':
                        if (this.aiSuggestion && this.aiSuggestion.content) {
                            this.stepInputs.formulatedDecision = this.aiSuggestion.content.refinedQuestion || 
                                                                this.aiSuggestion.content.refinedDecision || 
                                                                this.decisionQuestion;
                        } else {
                            this.stepInputs.formulatedDecision = this.decisionQuestion;
                        }
                        break;
                    case 'List options':
                        this.stepInputs.options = this.aiSuggestion.content.options || [{ name: '', description: '', pros: '', cons: '' }];
                        break;
                    case 'Define factors':
                        this.stepInputs.factors = this.aiSuggestion.content.factors || [{ name: '' }];
                        break;
                    case 'Weigh outcomes':
                        console.log('Options:', this.stepInputs.options);
                        console.log('Factors:', this.stepInputs.factors);
                        this.stepInputs.weights = {};
                        this.stepInputs.options.forEach((option, optionIndex) => {
                            this.stepInputs.weights[optionIndex] = {};
                            this.stepInputs.factors.forEach((factor, factorIndex) => {
                                this.stepInputs.weights[optionIndex][factorIndex] = 5; // Middle value on 1-10 scale
                            });
                        });
                        console.log('Initialized weights:', this.stepInputs.weights);
                        break;
                    case 'Make a choice':
                        this.stepInputs.finalChoice = this.aiSuggestion.content.optimalChoice || '';
                        this.stepInputs.reasoning = this.aiSuggestion.content.reasoning || '';
                        break;
                }
            },
            previousStep() {
                if (this.currentStepIndex > 0) {
                    this.currentStepIndex--;
                    this.currentStep = this.frameworks[this.decisionType].steps[this.currentStepIndex];
                    this.progress = (this.currentStepIndex / (this.frameworks[this.decisionType].steps.length - 1)) * 100;
                }
            },
            startOver() {
                this.decisionStarted = false;
                this.decisionCompleted = false;
                this.currentStepIndex = 0;
                this.stepInputs = {
                    formulatedDecision: '',
                    options: [],
                    factors: [],
                    weights: {},
                    finalChoice: '',
                    reasoning: ''
                };
                this.progress = 0;
            },
            saveDecision() {
                axios.post('/save_decision', {
                    question: this.decisionQuestion,
                    framework: this.decisionType,
                    response: JSON.stringify({
                        steps: this.allStepInputs,
                        summary: this.decisionSummary
                    })
                })
                .then(response => {
                    this.decisionSaved = true;
                    this.savedDecisionId = response.data.id;
                    this.fetchSavedDecisions();
                })
                .catch(error => {
                    console.error('Error saving decision:', error);
                    this.error = 'Error saving decision. Please try again.';
                });
            },
            fetchSavedDecisions() {
                axios.get('/get_decisions')
                .then(response => {
                    this.savedDecisions = response.data;
                })
                .catch(error => {
                    console.error('Error fetching saved decisions:', error);
                    this.error = 'Error fetching saved decisions. Please try again.';
                });
            },
            showDecisionDetails(decision) {
                try {
                    decision.parsedResponse = JSON.parse(decision.response);
                } catch (e) {
                    console.error('Error parsing decision response:', e);
                    decision.parsedResponse = null;
                }
                this.selectedDecision = decision;
                this.rating = 0;
                this.feedbackComment = '';
            },
            closeDecisionDetails() {
                this.selectedDecision = null;
            },
            compareDecisions() {
                if (this.selectedDecisions.length < 2) return;
                axios.post('/compare_decisions', {
                    decision_ids: this.selectedDecisions
                })
                .then(response => {
                    this.comparisonResult = response.data.comparison;
                })
                .catch(error => {
                    console.error('Error comparing decisions:', error);
                    this.error = 'Error comparing decisions. Please try again.';
                });
            },
            checkLoginStatus() {
                axios.get('/check_login')
                .then(response => {
                    this.isLoggedIn = response.data.logged_in;
                    if (this.isLoggedIn) {
                        this.fetchSavedDecisions();
                        this.fetchFeedback();
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    this.error = 'Error checking login status. Please try refreshing the page.';
                });
            },
            fetchFeedback() {
                axios.get('/get_feedback')
                .then(response => {
                    this.userFeedback = response.data;
                })
                .catch(error => {
                    console.error('Error fetching feedback:', error);
                    this.error = 'Error fetching feedback. Please try again.';
                });
            },
            setRating(value) {
                this.rating = value;
            },
            submitFeedback(decisionId) {
                if (!this.rating) return;
                axios.post('/submit_feedback', {
                    decision_id: decisionId,
                    rating: this.rating,
                    comment: this.feedbackComment
                })
                .then(() => {
                    // Update the decision in the savedDecisions array
                    const index = this.savedDecisions.findIndex(d => d.id === decisionId);
                    if (index !== -1) {
                        this.$set(this.savedDecisions[index], 'feedback', {
                            rating: this.rating,
                            comment: this.feedbackComment
                        });
                    }
                    // Update the selectedDecision if it's the one we just added feedback to
                    if (this.selectedDecision && this.selectedDecision.id === decisionId) {
                        this.$set(this.selectedDecision, 'feedback', {
                            rating: this.rating,
                            comment: this.feedbackComment
                        });
                    }
                    alert('Thank you for your feedback!');
                    this.rating = 0;
                    this.feedbackComment = '';
                })
                .catch(error => {
                    console.error('Error submitting feedback:', error);
                    alert('Error submitting feedback. Please try again.');
                });
            },
        },
        mounted() {
            axios.get('/frameworks')
                .then(response => {
                    this.frameworks = response.data;
                    this.updateFrameworkInfo();
                })
                .catch(error => {
                    console.error('Error fetching frameworks:', error);
                    this.error = 'Error fetching decision frameworks. Please try refreshing the page.';
                });
            this.checkLoginStatus();
        }
    });
    </script>
</body>
</html>